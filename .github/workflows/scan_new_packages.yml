name: Scan new pypi pkgs
on:
  workflow_dispatch:
  schedule:
    - cron:  '*/30 * * * *'


jobs:
  scan_new_pypi_pkgs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    - run: pip3 install semgrep

    - name: clone rules repo
      run: |
        git clone https://github.com/h4sh5/h4sh-semgrep-rules

    - name: get new packages names
      run: python3 get_packages.py | tee new.txt


    - name: download all new packages
      run: |
        mkdir packages;
        cd packages;
        cat ../new.txt | parallel pip download || echo ignoring some error $?
        for i in *; do unzip -- "$i"; done || echo ignorin error $?
        for i in $(cat ../scanned_pkgs.txt); do rm -rf -- "$i" "$i-dist-info"; done

    - name: run semgrep scan
      run: |
        semgrep --json -c h4sh-semgrep-rules/python packages/ | tee report.json
    
    - name: high risk pkgs detection
      run: |
        python3 raise_high_risk_pkgs.py
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: run secret scan
      run: semgrep -c p/secrets packages/ | tee -a secrets.txt

    - name: suspicious files detection
      run: |
        bash detect_sus_file_formats.sh 
    - name: Push scanned packages to cache
      run: | 
        cat new.txt >> scanned_pkgs.txt
        cd packages/ ; ls -d * |  grep -v dist-info >> ../scanned_pkgs.txt; cd ..
        sort -u scanned_pkgs.txt > scanned_pkgs.txt.1
        mv scanned_pkgs.txt.1 scanned_pkgs.txt
        git add *.txt *.csv
        git config --global user.name 'PyPi Scan Bot by h4sh'
        git config --global user.email 'pypi-scan-bot-h4sh@open-source.local'
        git commit -m "new scan output $(date)"
        git push 

    - name: Archive code coverage results
      uses: actions/upload-artifact@v3
      with:
        name: new-scan-report
        path: report.json




